
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Race Director Sim ‚Äì v4.1.0</title>
<style>
  html,body{margin:0;background:#0b0f1a;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:flex;gap:16px;flex-wrap:wrap;padding:12px}
  #game{background:#111827;border:1px solid #2d3a54;border-radius:12px;padding:10px;max-width:100%}
  .title{font-weight:800;font-size:18px;margin-bottom:6px;letter-spacing:.2px}
  canvas{display:block;border-radius:12px;background:#071019;max-width:100%;height:auto}
  .hud{display:flex;gap:12px;margin-top:6px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid #2d3a54;border-radius:999px;background:#18243a}
  .muted{color:#b7c3d9}
  select,button{background:#18243a;color:#eaeaea;border:1px solid #2d3a54;border-radius:10px;padding:8px 12px;cursor:pointer}
  button:hover{filter:brightness(1.08)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div id="game">
    <div class="title">Race Director Sim ‚Äì v4.1.0 (Imola & Monza)</div>
    <canvas id="cv" width="1180" height="720"></canvas>

    <div class="controls">
      <label class="pill">Circuito:
        <select id="trackSel">
          <option value="imola">Imola</option>
          <option value="monza">Monza</option>
        </select>
      </label>
      <button id="btnStart">‚ñ∂Ô∏è Avvia / Pausa</button>
      <button id="btnRestart">üîÅ Restart</button>
      <span class="pill">Meteo: <b id="wx">‚Äî</b></span>
      <span class="pill">Giro: <b id="lap">1</b>/<b id="maxLap">10</b></span>
      <span class="pill">Loop: <b>setInterval</b></span>
      <span class="muted">Parte da solo. Tasti: Spazio = Avvia/Pausa, R = Restart</span>
    </div>
  </div>
</div>

<script>
(function(){
  const cv=document.getElementById('cv'); const ctx=cv.getContext('2d',{alpha:false});
  const W=cv.width,H=cv.height;
  const lapEl=document.getElementById('lap'); const wxEl=document.getElementById('wx'); const sel=document.getElementById('trackSel');
  const maxLap=10; document.getElementById('maxLap').textContent=maxLap;

  // ====== Tracce ======
  const IMOLA=[[-.25,-.95],[.55,-.92],[.8,-.7],[.88,-.35],[.75,-.05],[.4,0],[.1,.1],[-.1,.35],[-.25,.6],[-.4,.85],[-.7,.95],[-.9,.75],[-.88,.4],[-.7,.1],[-.4,-.05],[-.1,-.25],[.05,-.55],[0,-.8],[-.1,-.92],[-.25,-.95]];
  const MONZA=[[.9,-.9],[.1,-.9],[-.5,-.8],[-.85,-.55],[-.9,-.2],[-.65,.05],[-.3,.05],[-.05,0],[.2,-.1],[.45,-.05],[.7,.1],[.85,.35],[.8,.6],[.55,.8],[.2,.9],[-.2,.9],[-.65,.85],[-.9,.7],[-.95,.45],[-.85,.15],[-.55,-.05],[-.1,-.15],[.5,-.2],[.9,-.3],[.95,-.6],[.9,-.9]];

  function buildPath(poly,pad=90){
    const xs=poly.map(p=>p[0]), ys=poly.map(p=>p[1]);
    const minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);
    const w=maxX-minX,h=maxY-minY; const s=Math.min((W-2*pad)/w,(H-2*pad)/h);
    const ox=pad-minX*s, oy=pad-minY*s;
    const P=poly.map(([x,y])=>({x:x*s+ox,y:y*s+oy}));
    let L=[0],len=0;
    for(let i=1;i<P.length;i++){ const dx=P[i].x-P[i-1].x, dy=P[i].y-P[i-1].y; const seg=Math.hypot(dx,dy); len+=seg; L.push(len); }
    return {P,L,len,scale:s};
  }
  function posOnPath(path,d){
    const D=((d%path.len)+path.len)%path.len;
    let i=1; while(i<path.L.length&&path.L[i]<D) i++;
    const d0=path.L[i-1], d1=path.L[i]; const t=(D-d0)/(d1-d0+1e-6);
    const a=path.P[i-1], b=path.P[i]; const x=a.x+(b.x-a.x)*t, y=a.y+(b.y-a.y)*t;
    const ang=Math.atan2(b.y-a.y,b.x-a.x); const nx=-Math.sin(ang), ny=Math.cos(ang);
    return {x,y,ang,nx,ny};
  }

  // ====== Meteo ======
  const WX=[
    {n:"Sole", sky1:"#79c6ff", sky2:"#1c3b6b", asphalt:"#4a5f8f", fog:0, rain:0},
    {n:"Coperto", sky1:"#98a8bd", sky2:"#2d3a54", asphalt:"#455a86", fog:0.02, rain:0},
    {n:"Pioggia", sky1:"#8ea3b8", sky2:"#334257", asphalt:"#3f537c", fog:0.06, rain:160}
  ];
  let wx=WX[0]; function pickWX(){ wx=WX[Math.floor(Math.random()*WX.length)]; wxEl.textContent=wx.n; }

  // ====== Grafica ======
  function drawSky(){
    const g=ctx.createLinearGradient(0,0,0,H*0.55); g.addColorStop(0,wx.sky1); g.addColorStop(1,wx.sky2);
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    // nuvole
    ctx.globalAlpha=0.12;
    for(let i=0;i<8;i++){ const r=60+Math.random()*120,x=Math.random()*W,y=40+Math.random()*180;
      const grad=ctx.createRadialGradient(x,y,r*0.2,x,y,r); grad.addColorStop(0,"#fff"); grad.addColorStop(1,"transparent");
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,r,0,6.28); ctx.fill();
    }
    ctx.globalAlpha=1;
  }
  function drawEnvironment(){
    // colline
    ctx.fillStyle="#0f2b3a"; ctx.beginPath(); ctx.moveTo(0,H*0.55);
    for(let x=0;x<=W;x+=40){ const y=H*0.55+Math.sin(x*.004)*14+Math.cos(x*.007)*10+12; ctx.lineTo(x,y); }
    ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();
    // erba
    ctx.fillStyle="#0e3c2e"; ctx.fillRect(0,H*0.60,W,H*0.40);
    // alberi
    for(let i=0;i<30;i++){ const x=Math.random()*W, y=H*0.58+(Math.random()*20-10), h=18+Math.random()*20;
      ctx.fillStyle="#0a2d22"; ctx.fillRect(x-2,y,4,h);
      ctx.fillStyle="#164a37"; ctx.beginPath(); ctx.arc(x,y,8+Math.random()*8,0,6.28); ctx.fill();
    }
    // tribune
    const base=H*0.59;
    for(let i=0;i<4;i++){ const w=200+Math.random()*90, x=80+i*260;
      ctx.fillStyle="#1a253a"; ctx.fillRect(x,base-40,w,40);
      ctx.fillStyle=["#ff5252","#ffd600","#40c4ff","#00e676"][i%4]; ctx.fillRect(x+6,base-52,88,10);
      for(let k=0;k<220;k++){
        const px=x+Math.random()*w, py=base-40+Math.random()*38;
        ctx.fillStyle=["#f06292","#ffd600","#80cbc4","#ef9a9a","#90caf9","#ffab40"][k%6];
        ctx.fillRect(px,py,1.2,1.2);
      }
    }
  }
  function drawTrack(path){
    ctx.strokeStyle="rgba(0,0,0,.35)"; ctx.lineWidth=44; ctx.lineCap="round"; ctx.lineJoin="round";
    ctx.beginPath(); ctx.moveTo(path.P[0].x,path.P[0].y); for(let i=1;i<path.P.length;i++) ctx.lineTo(path.P[i].x,path.P[i].y); ctx.stroke();
    ctx.strokeStyle=wx.asphalt; ctx.lineWidth=36; ctx.beginPath(); ctx.moveTo(path.P[0].x,path.P[0].y); for(let i=1;i<path.P.length;i++) ctx.lineTo(path.P[i].x,path.P[i].y); ctx.stroke();
    // Cordoli
    ctx.lineWidth=4;
    for(let i=1;i<path.P.length;i++){
      const a=path.P[i-1], b=path.P[i]; const ang=Math.atan2(b.y-a.y,b.x-a.x);
      const nx=-Math.sin(ang), ny=Math.cos(ang);
      const segL=Math.hypot(b.x-a.x,b.y-a.y); const steps=Math.floor(segL/14);
      for(let s=0;s<steps;s++){
        const t1=s/steps, t2=(s+0.5)/steps;
        const x1=a.x+(b.x-a.x)*t1+nx*22, y1=a.y+(b.y-a.y)*t1+ny*22;
        const x2=a.x+(b.x-a.x)*t2+nx*22, y2=a.y+(b.y-a.y)*t2+ny*22;
        ctx.strokeStyle=(s%2===0)?"#e53935":"#eceff1";
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      }
    }
    // Linea centrale
    ctx.setLineDash([14,14]); ctx.strokeStyle="#c9d6ff"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(path.P[0].x,path.P[0].y); for(let i=1;i<path.P.length;i++) ctx.lineTo(path.P[i].x,path.P[i].y); ctx.stroke();
    ctx.setLineDash([]);
  }

  // ====== Auto ======
  const palette=["#e10600","#00d2be","#0600ef","#ff9800","#00c853","#8e24aa","#ffd600","#40c4ff"];
  function drawF1(x,y,ang,col){
    ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
    ctx.globalAlpha=.35; ctx.fillStyle="#000"; ctx.beginPath(); ctx.ellipse(3,4,26,10,0,0,6.28); ctx.fill(); ctx.globalAlpha=1;
    ctx.fillStyle="#e3e7f1"; ctx.fillRect(-28,-8,12,16); ctx.fillRect(18,-6,8,12);
    const grd=ctx.createLinearGradient(-20,-8,26,8); grd.addColorStop(0,col); grd.addColorStop(1,"#111");
    ctx.fillStyle=grd; ctx.fillRect(-20,-7,40,14);
    ctx.fillStyle=col; ctx.beginPath(); ctx.moveTo(-2,-7); ctx.lineTo(26,-2); ctx.lineTo(26,2); ctx.lineTo(-2,7); ctx.closePath(); ctx.fill();
    ctx.fillStyle="#0b0b0e"; const r=4.4;
    ctx.beginPath(); ctx.arc(-12,-10,r,0,6.28); ctx.fill();
    ctx.beginPath(); ctx.arc(-12,10,r,0,6.28); ctx.fill();
    ctx.beginPath(); ctx.arc(12,-10,r,0,6.28); ctx.fill();
    ctx.beginPath(); ctx.arc(12,10,r,0,6.28); ctx.fill();
    ctx.restore();
  }

  // ====== Stato ======
  let path=buildPath(IMOLA), cars=[], lap=1, running=true;
  function reset(which){
    path=buildPath(which==="monza"?MONZA:IMOLA);
    cars = new Array(10).fill(0).map((_,i)=>({d:i*60, v:110+Math.random()*24, c:palette[i%palette.length], lap:1}));
    lap=1; pickWX();
  }
  reset("imola");
  sel.addEventListener('change',()=>{ reset(sel.value); });

  function step(){
    drawSky(); drawEnvironment(); drawTrack(path);
    if(wx.fog>0){ ctx.fillStyle="rgba(200,215,230,"+wx.fog+")"; ctx.fillRect(0,0,W,H); }
    if(running){
      let maxLap=1;
      for(const c of cars){
        c.d += c.v * 0.016;
        if(c.d>path.len){ c.d-=path.len; c.lap+=1; }
        const p=posOnPath(path,c.d);
        ctx.globalAlpha=.35; drawF1(p.x- Math.cos(p.ang)*8, p.y- Math.sin(p.ang)*8, p.ang, c.c); ctx.globalAlpha=1;
        drawF1(p.x,p.y,p.ang,c.c);
        if(c.lap>maxLap) maxLap=c.lap;
      }
      lap = maxLap; lapEl.textContent=lap;
    } else {
      // static draw already done
    }
  }

  // Autostart (compatibile anche se i click sono bloccati)
  setInterval(step, 16);
  step();

  // Controlli
  const btnStart=document.getElementById('btnStart');
  const btnRestart=document.getElementById('btnRestart');
  function toggle(){ running=!running; btnStart.textContent = running ? "‚è∏Ô∏è Pausa" : "‚ñ∂Ô∏è Avvia"; }
  function restart(){ reset(sel.value); running=true; btnStart.textContent="‚è∏Ô∏è Pausa"; }
  ["click","pointerdown","touchstart"].forEach(t=>{
    btnStart.addEventListener(t,(e)=>{ e.preventDefault(); toggle(); },{passive:false});
    btnRestart.addEventListener(t,(e)=>{ e.preventDefault(); restart(); },{passive:false});
  });
  document.addEventListener('keydown',(e)=>{
    if(e.code==="Space"){ e.preventDefault(); toggle(); }
    if(e.key==="r"||e.key==="R"){ restart(); }
  });
})();
</script>
</body>
</html>
