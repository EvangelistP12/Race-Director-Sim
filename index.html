<!doctype html>
<html lang="it">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Race Director Sim – DIAGNOSTICO</title>
<style>
  body{margin:0;background:#0b0f1a;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{padding:10px}
  #hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  button,select{background:#18243a;color:#eaeaea;border:1px solid #2d3a54;border-radius:10px;padding:8px 12px}
  canvas{display:block;background:#071019;border-radius:12px;max-width:100%;height:auto}
</style>
<body>
<div class="wrap">
  <div id="hud">
    <label> Circuito:
      <select id="track"><option value="imola">Imola</option><option value="monza">Monza</option></select>
    </label>
    <button id="toggle">⏯ Avvia/Pausa</button>
    <span>Giro: <b id="lap">1</b></span>
    <span id="err" style="color:#ff8080"></span>
  </div>
  <canvas id="cv" width="1180" height="720"></canvas>
</div>

<script>
/* Cattura errori in rosso */
window.onerror=(m,src,l,c)=>{document.getElementById('err').textContent="Errore: "+m+" @"+l+":"+c;}

const cv=document.getElementById('cv'), ctx=cv.getContext('2d',{alpha:false});
const W=cv.width,H=cv.height, lapEl=document.getElementById('lap'), sel=document.getElementById('track');
let running=true, lap=1;

const IMOLA=[[-.25,-.95],[.55,-.92],[.8,-.7],[.88,-.35],[.75,-.05],[.4,0],[.1,.1],[-.1,.35],[-.25,.6],[-.4,.85],[-.7,.95],[-.9,.75],[-.88,.4],[-.7,.1],[-.4,-.05],[-.1,-.25],[.05,-.55],[0,-.8],[-.1,-.92],[-.25,-.95]];
const MONZA=[[.9,-.9],[.1,-.9],[-.5,-.8],[-.85,-.55],[-.9,-.2],[-.65,.05],[-.3,.05],[-.05,0],[.2,-.1],[.45,-.05],[.7,.1],[.85,.35],[.8,.6],[.55,.8],[.2,.9],[-.2,.9],[-.65,.85],[-.9,.7],[-.95,.45],[-.85,.15],[-.55,-.05],[-.1,-.15],[.5,-.2],[.9,-.3],[.95,-.6],[.9,-.9]];

function buildPath(poly,pad=90){
  const xs=poly.map(p=>p[0]), ys=poly.map(p=>p[1]);
  const minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);
  const s=Math.min((W-2*pad)/(maxX-minX),(H-2*pad)/(maxY-minY));
  const ox=pad-minX*s, oy=pad-minY*s;
  const P=poly.map(([x,y])=>({x:x*s+ox,y:y*s+oy}));
  let L=[0],len=0; for(let i=1;i<P.length;i++){const dx=P[i].x-P[i-1].x,dy=P[i].y-P[i-1].y;const d=Math.hypot(dx,dy);len+=d;L.push(len);}
  return {P,L,len};
}
function posOnPath(path,d){
  const D=((d%path.len)+path.len)%path.len;
  let i=1; while(i<path.L.length&&path.L[i]<D) i++;
  const a=path.P[i-1], b=path.P[i], d0=path.L[i-1], d1=path.L[i];
  const t=(D-d0)/Math.max(1e-6,(d1-d0)); const x=a.x+(b.x-a.x)*t, y=a.y+(b.y-a.y)*t;
  const ang=Math.atan2(b.y-a.y,b.x-a.x); return {x,y,ang};
}

let path=buildPath(IMOLA);
function setTrack(v){ path=buildPath(v==="monza"?MONZA:IMOLA); }
sel.onchange=()=>{ setTrack(sel.value); cars.forEach((c,i)=>{c.d=i*60;c.lap=1;}); lap=1; };

const palette=["#e10600","#00d2be","#0600ef","#ff9800","#00c853","#8e24aa","#ffd600","#40c4ff"];
const cars=new Array(10).fill(0).map((_,i)=>({d:i*60,v:110+Math.random()*24,c:palette[i%palette.length],lap:1}));

function drawF1(x,y,ang,col){
  ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
  ctx.globalAlpha=.35; ctx.fillStyle="#000"; ctx.beginPath(); ctx.ellipse(3,4,26,10,0,0,6.28); ctx.fill(); ctx.globalAlpha=1;
  ctx.fillStyle=col; ctx.fillRect(-20,-6,40,12); // corpo semplice
  ctx.fillStyle="#0b0b0e"; const r=4.4;
  ctx.beginPath(); ctx.arc(-12,-10,r,0,6.28); ctx.fill();
  ctx.beginPath(); ctx.arc(-12,10,r,0,6.28); ctx.fill();
  ctx.beginPath(); ctx.arc(12,-10,r,0,6.28); ctx.fill();
  ctx.beginPath(); ctx.arc(12,10,r,0,6.28); ctx.fill();
  ctx.restore();
}

function drawTrack(){
  ctx.strokeStyle="rgba(0,0,0,.35)"; ctx.lineWidth=44; ctx.lineCap="round"; ctx.lineJoin="round";
  ctx.beginPath(); ctx.moveTo(path.P[0].x,path.P[0].y); for(let i=1;i<path.P.length;i++) ctx.lineTo(path.P[i].x,path.P[i].y); ctx.stroke();
  ctx.strokeStyle="#4a5f8f"; ctx.lineWidth=36; ctx.beginPath(); ctx.moveTo(path.P[0].x,path.P[0].y); for(let i=1;i<path.P.length;i++) ctx.lineTo(path.P[i].x,path.P[i].y); ctx.stroke();
}

let last=performance.now();
function loop(){
  const now=performance.now(), dt=now-last; last=now;
  ctx.fillStyle="#0c1424"; ctx.fillRect(0,0,W,H);
  drawTrack();
  if(running){
    let maxLap=1;
    for(const c of cars){
      c.d += c.v*(dt/1000);
      if(c.d>path.len){ c.d-=path.len; c.lap++; }
      const p=posOnPath(path,c.d);
      drawF1(p.x,p.y,p.ang,c.c);
      if(c.lap>maxLap) maxLap=c.lap;
    }
    lap=maxLap; lapEl.textContent=lap;
  } else {
    for(const c of cars){ const p=posOnPath(path,c.d); drawF1(p.x,p.y,p.ang,c.c); }
  }
  requestAnimationFrame(loop);
}
document.getElementById('toggle').onclick=()=>{ running=!running; };

setTrack('imola');
requestAnimationFrame(loop);
</script>
